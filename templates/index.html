<!DOCTYPE html>
<html>
<head>
    <title>Task Manager</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

<h1>My Tasks</h1>

<form method="POST" action="/add">
    <input type="text" name="description" placeholder="New task" required>

    <select name="priority" required>
        <option value="Low">Low</option>
        <option value="Medium" selected>Medium</option>
        <option value="High">High</option>
    </select>

    <button type="submit">Add Task</button>
</form>

{% if tasks %}
    <ul>
        {% for task in tasks %}
            <li>
                <span class="priority {{ task['priority'] | lower}}">
                    [{{ task["priority"] }}]
                </span>

                {{ task["description"] }}
                
                {% if task["completed"] %}
                    ✅
                {% else %}
                    ⏳
                    <form method="POST" action="/complete/{{ task['id'] }}" style="display:inline;">
                        <button type="submit">Complete</button>
                    </form>
                {% endif %}

                <form method="POST" action="/delete/{{ task['id'] }}" style="display: inline;">
                    <button type="submit">Delete</button>
                </form>

                <button type ="button" onclick="toggleEdit('{{ task.id }}')">Edit</button>

                <form
                    id="edit-form-{{ task['id'] }}"
                    class="edit-form"
                    data-task-id="{{ task['id'] }}"
                >
                    <input 
                        type="text"
                        name="description"
                        value="{{ task['description'] }}"
                        required
                    >

                    <select name="priority" required>
                        <option value="Low" {% if task['priority'] == 'Low' %}selected{% endif %}>Low</option>
                        <option value="Medium" {% if task['priority'] == 'Medium' %}selected{% endif %}>Medium</option>
                        <option value="High" {% if task['priority'] == 'High' %}selected{% endif %}>High</option>
                    </select>

                    <!-- <select name="priority" required>
                        <option value="Low" {% if task['priority'] == 'Low' %}selected{% endif %}>Low</option>
                        <option value="Medium" {% if task['priority'] == 'Medium' %}selected{% endif %}>Medium</option>
                        <option value="High" {% if task['priority'] == 'High' %}selected{% endif %}>High</option>
                    </select> -->
                    <button type="submit">Save</button>
                </form>

                <!-- <form method="POST" action="/edit/{{ task['id'] }}" style="display: inline;">
                    <input
                        type="text"
                        name="description"
                        placeholder="Edit task"
                        required
                    >
                    <button type="submit">Edit</button>
                </form> -->
            </li>
        {% endfor %}
    </ul>
{% else %}
    <p>No tasks found.</p>
{% endif %}

<script>
    document.querySelectorAll(".edit-form").forEach(form => {
        form.addEventListener("submit", event => {
            event.preventDefault();
            const taskId = form.dataset.taskId;
            submitEdit(taskId);
        });
    });

    function submitEdit(taskId) {

        const form = document.getElementById(`edit-form-${taskId}`);
        const description = form.querySelector("input[name='description']").value;
        const priority = form.querySelector("select[name='priority']").value;
        
        fetch(`/edit/${taskId}`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ 
                description: description,
                priority: priority
            
            })
        })
        .then(response => response.json())
        .then(() => {
            window.location.reload()
        });
    }

    function toggleEdit(taskId) {
        const form = document.getElementById(`edit-form-${taskId}`);
        form.style.display =
            form.style.display === "none" || form.style.display === ""
                ? "inline-block"
                : "none";
    }
</script>

</body>
</html>