<!DOCTYPE html>
<html>
<head>
    <title>Task Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .due-indicator {
            font-size: 0.85rem;
            margin-left: 8px;
        }
        .overdue {
            color: #dc3545;
            font-weight: bold;
        }
        .due-today {
            color: #fd7e14;
            font-weight: bold;
        }
        .due-soon {
            color: #ffc107;
        }
        .due-later {
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="card shadow-sm">
            <div class="card-body">
                <h1>My Tasks</h1>
                
                <!-- Add Task Form -->
                <form method="POST" action="/add" class="mb-4">
                    <div class="row g-2">
                        <div class="col-md-4">
                            <input type="text" name="description" class="form-control" placeholder="New task" required>
                        </div>
                        <div class="col-md-2">
                            <select name="priority" class="form-select" required>
                                <option value="Low">Low</option>
                                <option value="Medium" selected>Medium</option>
                                <option value="High">High</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <input type="datetime-local" name="due_date" class="form-control" placeholder="Due date (optional)">
                        </div>
                        <div class="col-md-3">
                            <button type="submit" class="btn btn-primary w-100">Add Task</button>
                        </div>
                    </div>
                </form>

                <!-- Filter and Sort Controls -->
                <div class="card bg-light mb-3">
                    <div class="card-body">
                        <form method="GET" action="/" class="row g-2 align-items-end">
                            <div class="col-md-2">
                                <label class="form-label small mb-1">Priority</label>
                                <select name="filter_priority" class="form-select form-select-sm">
                                    <option value="all" {% if filter_priority == 'all' %}selected{% endif %}>All</option>
                                    <option value="high" {% if filter_priority == 'high' %}selected{% endif %}>High</option>
                                    <option value="medium" {% if filter_priority == 'medium' %}selected{% endif %}>Medium</option>
                                    <option value="low" {% if filter_priority == 'low' %}selected{% endif %}>Low</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small mb-1">Status</label>
                                <select name="filter_status" class="form-select form-select-sm">
                                    <option value="all" {% if filter_status == 'all' %}selected{% endif %}>All</option>
                                    <option value="active" {% if filter_status == 'active' %}selected{% endif %}>Active</option>
                                    <option value="completed" {% if filter_status == 'completed' %}selected{% endif %}>Completed</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small mb-1">Due Date</label>
                                <select name="filter_due" class="form-select form-select-sm">
                                    <option value="all" {% if filter_due == 'all' %}selected{% endif %}>All</option>
                                    <option value="overdue" {% if filter_due == 'overdue' %}selected{% endif %}>Overdue</option>
                                    <option value="today" {% if filter_due == 'today' %}selected{% endif %}>Due Today</option>
                                    <option value="upcoming" {% if filter_due == 'upcoming' %}selected{% endif %}>Next 7 Days</option>
                                    <option value="no_date" {% if filter_due == 'no_date' %}selected{% endif %}>No Due Date</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small mb-1">Sort by</label>
                                <select name="sort_by" class="form-select form-select-sm">
                                    <option value="urgency" {% if sort_by == 'urgency' %}selected{% endif %}>Urgency (Due + Priority)</option>
                                    <option value="due_date" {% if sort_by == 'due_date' %}selected{% endif %}>Due Date (Earliest First)</option>
                                    <option value="due_date_desc" {% if sort_by == 'due_date_desc' %}selected{% endif %}>Due Date (Latest First)</option>
                                    <option value="priority" {% if sort_by == 'priority' %}selected{% endif %}>Priority (High â†’ Low)</option>
                                    <option value="priority_desc" {% if sort_by == 'priority_desc' %}selected{% endif %}>Priority (Low â†’ High)</option>
                                    <option value="description" {% if sort_by == 'description' %}selected{% endif %}>Description (A â†’ Z)</option>
                                    <option value="description_desc" {% if sort_by == 'description_desc' %}selected{% endif %}>Description (Z â†’ A)</option>
                                    <option value="date_added" {% if sort_by == 'date_added' %}selected{% endif %}>Date Added (Oldest)</option>
                                    <option value="date_added_desc" {% if sort_by == 'date_added_desc' %}selected{% endif %}>Date Added (Newest)</option>
                                    <option value="id" {% if sort_by == 'id' %}selected{% endif %}>Order Added</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button type="submit" class="btn btn-secondary btn-sm w-100">Apply</button>
                            </div>
                        </form>
                    </div>
                </div>
                
                {% if tasks %}
                    <div class="mb-2 text-muted small">
                        Showing {{ tasks|length }} task(s)
                    </div>
                    <ul class="list-group">
                        {% for task in tasks %}
                            {% set now = None %}
                            {% set due_class = '' %}
                            {% set due_text = '' %}
                            {% if task['due_date'] %}
                                {% set due_dt = task['due_date'][:19] %}
                                <script>
                                    (function() {
                                        const dueDate = new Date('{{ due_dt }}');
                                        const now = new Date();
                                        const diffMs = dueDate - now;
                                        const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
                                        const diffHours = Math.ceil(diffMs / (1000 * 60 * 60));
                                        
                                        const listItem = document.currentScript.closest('li');
                                        const indicator = listItem.querySelector('.due-indicator-{{ task["id"] }}');
                                        
                                        if (diffMs < 0) {
                                            indicator.className = 'due-indicator due-indicator-{{ task["id"] }} overdue';
                                            if (diffDays <= -2) {
                                                indicator.textContent = 'âš ï¸ Overdue by ' + Math.abs(diffDays) + ' days';
                                            } else if (diffHours <= -2) {
                                                indicator.textContent = 'âš ï¸ Overdue by ' + Math.abs(diffHours) + ' hours';
                                            } else {
                                                indicator.textContent = 'âš ï¸ Overdue';
                                            }
                                        } else if (diffDays === 0) {
                                            indicator.className = 'due-indicator due-indicator-{{ task["id"] }} due-today';
                                            if (diffHours <= 3) {
                                                indicator.textContent = 'ðŸ”¥ Due in ' + diffHours + ' hour(s)';
                                            } else {
                                                indicator.textContent = 'ðŸ”¥ Due today';
                                            }
                                        } else if (diffDays === 1) {
                                            indicator.className = 'due-indicator due-indicator-{{ task["id"] }} due-today';
                                            indicator.textContent = 'â° Due tomorrow';
                                        } else if (diffDays <= 3) {
                                            indicator.className = 'due-indicator due-indicator-{{ task["id"] }} due-soon';
                                            indicator.textContent = 'ðŸ“… Due in ' + diffDays + ' days';
                                        } else if (diffDays <= 7) {
                                            indicator.className = 'due-indicator due-indicator-{{ task["id"] }} due-soon';
                                            indicator.textContent = 'ðŸ“… Due in ' + diffDays + ' days';
                                        } else {
                                            indicator.className = 'due-indicator due-indicator-{{ task["id"] }} due-later';
                                            const options = { month: 'short', day: 'numeric', year: 'numeric' };
                                            indicator.textContent = 'ðŸ“… Due ' + dueDate.toLocaleDateString('en-US', options);
                                        }
                                    })();
                                </script>
                            {% endif %}
                            
                            <li class="list-group-item {% if task['completed'] %}bg-light text-muted{% endif %}">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="task-content flex-grow-1" data-task-id="{{ task['id'] }}">
                                        <span class="badge
                                            {% if task['priority'] == 'High' %}bg-danger
                                            {% elif task['priority'] == 'Medium' %}bg-warning text-dark
                                            {% else %}bg-success
                                            {% endif %}
                                        ">
                                            {{ task['priority'] }}
                                        </span>
                                        <span {% if task['completed'] %}style="text-decoration: line-through;"{% endif %}>
                                            {{ task['description'] }}
                                        </span>
                                        {% if task['due_date'] %}
                                            <span class="due-indicator due-indicator-{{ task['id'] }}"></span>
                                        {% endif %}
                                    </div>
                                    <div class="d-flex gap-2 flex-shrink-0">
                                        {% if not task['completed'] %}
                                            <button type="button" class="btn btn-sm btn-outline-success complete-btn" data-task-id="{{ task['id'] }}">âœ“</button>
                                        {% else %}
                                            <button type="button" class="btn btn-sm btn-outline-secondary complete-btn" data-task-id="{{ task['id'] }}">â†¶</button>
                                        {% endif %}
                                        <button type="button" class="btn btn-sm btn-outline-secondary edit-btn" data-task-id="{{ task['id'] }}">Edit</button>
                                        <button type="button" class="btn btn-sm btn-outline-danger delete-btn" data-task-id="{{ task['id'] }}">Ã—</button>
                                    </div>
                                </div>

                                <form id="edit-form-{{ task['id'] }}" class="edit-form mt-2 border p-2 bg-white d-none" data-task-id="{{ task['id'] }}">
                                    <div class="row g-2">
                                        <div class="col-md-4">
                                            <input type="text" name="description" class="form-control form-control-sm" value="{{ task['description'] }}" required>
                                        </div>    
                                        <div class="col-md-2">
                                            <select name="priority" class="form-select form-select-sm" required>
                                                <option value="Low" {% if task['priority'] == 'Low' %}selected{% endif %}>Low</option>
                                                <option value="Medium" {% if task['priority'] == 'Medium' %}selected{% endif %}>Medium</option>
                                                <option value="High" {% if task['priority'] == 'High' %}selected{% endif %}>High</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <input type="datetime-local" name="due_date" class="form-control form-control-sm" value="{{ task['due_date'][:16] if task.get('due_date') else '' }}">
                                        </div>
                                        <div class="col-md-3">
                                            <button type="submit" class="btn btn-sm btn-primary w-100">Save</button>
                                        </div>
                                    </div>
                                </form>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <div class="alert alert-info">
                        No tasks found matching your filters.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // Toggle edit form
            document.querySelectorAll(".edit-btn").forEach(btn => {
                btn.addEventListener("click", () => {
                    const taskId = btn.dataset.taskId;
                    const form = document.getElementById(`edit-form-${taskId}`);
                    if (form) {
                        form.classList.toggle("d-none");
                    }
                });
            });

            // Handle edit form submission
            document.querySelectorAll(".edit-form").forEach(form => {
                form.addEventListener("submit", e => {
                    e.preventDefault();

                    const taskId = form.dataset.taskId;
                    const description = form.querySelector("[name='description']").value;
                    const priority = form.querySelector("[name='priority']").value;
                    const dueDate = form.querySelector("[name='due_date']").value;

                    fetch(`/edit/${taskId}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ 
                            description, 
                            priority,
                            due_date: dueDate || null
                        })
                    })
                    .then(res => res.json())
                    .then(data => {
                        if(data.success){
                            window.location.reload();
                        } else {
                            alert("Failed to update task: " + (data.error || "Unknown error"));
                        }
                    })
                    .catch(err => {
                        console.error("Error:", err);
                        alert("Error updating task: " + err.message);
                    });
                });
            });

            // Complete button
            document.querySelectorAll(".complete-btn").forEach(btn => {
                btn.addEventListener("click", () => {
                    fetch(`/complete/${btn.dataset.taskId}`, { method: "POST" })
                    .then(() => window.location.reload());
                });
            });

            // Delete button
            document.querySelectorAll(".delete-btn").forEach(btn => {
                btn.addEventListener("click", () => {
                    if(confirm("Are you sure you want to delete this task?")) {
                        fetch(`/delete/${btn.dataset.taskId}`, { method: "POST" })
                        .then(() => window.location.reload());
                    }
                });
            });
        });
    </script>
</body>
</html>